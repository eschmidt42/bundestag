---

title: Parsing votes


keywords: fastai
sidebar: home_sidebar

summary: "Downloading & parsing votes Aafter downloading xlsx files behind the links on `https://www.bundestag.de/parlament/plenum/abstimmung/liste`."
description: "Downloading & parsing votes Aafter downloading xlsx files behind the links on `https://www.bundestag.de/parlament/plenum/abstimmung/liste`."
nb_path: "nbs/00_html_parsing.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/00_html_parsing.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Setup">Setup<a class="anchor-link" href="#Setup"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Collecting-URIs-for-.xlsx/.xls-documents-from-.htm-files">Collecting URIs for <code>.xlsx</code>/<code>.xls</code> documents from <code>.htm</code> files<a class="anchor-link" href="#Collecting-URIs-for-.xlsx/.xls-documents-from-.htm-files"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>.xlsx</code> / <code>.xls</code> will be referred as "sheet" files.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">html_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;../website_data&#39;</span><span class="p">)</span>
<span class="n">sheet_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;../sheets&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_file_paths" class="doc_header"><code>get_file_paths</code><a href="https://github.com/eschmidt42/bundestag/tree/master/bundestag/parsing.py#L24" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_file_paths</code>(<strong><code>path</code></strong>:<code>Union</code>[<code>Path</code>, <code>str</code>], <strong><code>suffix</code></strong>:<code>str</code>=<em><code>None</code></em>, <strong><code>pattern</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Collecting files with a specific suffix or pattern from <code>path</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">html_file_paths</span> <span class="o">=</span> <span class="n">get_file_paths</span><span class="p">(</span><span class="n">html_path</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="n">RE_HTM</span><span class="p">)</span>
<span class="n">html_file_paths</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">html_file_paths</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="collect_sheet_uris" class="doc_header"><code>collect_sheet_uris</code><a href="https://github.com/eschmidt42/bundestag/tree/master/bundestag/parsing.py#L31" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>collect_sheet_uris</code>(<strong><code>html_file_paths</code></strong>:<code>List</code>[<code>Path</code>])</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">sheet_uris</span> <span class="o">=</span> <span class="n">collect_sheet_uris</span><span class="p">(</span><span class="n">html_file_paths</span><span class="p">)</span>
<span class="nb">list</span><span class="p">(</span><span class="n">sheet_uris</span><span class="o">.</span><span class="n">items</span><span class="p">())[:</span><span class="mi">3</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">sheet_uris</span><span class="o">.</span><span class="n">items</span><span class="p">())[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Downloading-sheet-files">Downloading sheet files<a class="anchor-link" href="#Downloading-sheet-files"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="download_sheet" class="doc_header"><code>download_sheet</code><a href="https://github.com/eschmidt42/bundestag/tree/master/bundestag/parsing.py#L49" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>download_sheet</code>(<strong><code>uri</code></strong>:<code>str</code>, <strong><code>sheet_path</code></strong>:<code>Union</code>[<code>Path</code>, <code>str</code>], <strong><code>verbose</code></strong>:<code>bool</code>=<em><code>False</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">uri</span> <span class="o">=</span> <span class="n">sheet_uris</span><span class="p">[</span><span class="s1">&#39;10.09.2020: Abstrakte Normenkontrolle - Düngeverordnung (Beschlussempfehlung)&#39;</span><span class="p">]</span>
<span class="n">download_sheet</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">sheet_path</span><span class="o">=</span><span class="n">sheet_path</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="download_multiple_sheets" class="doc_header"><code>download_multiple_sheets</code><a href="https://github.com/eschmidt42/bundestag/tree/master/bundestag/parsing.py#L59" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>download_multiple_sheets</code>(<strong><code>uris</code></strong>:<code>Dict</code>[<code>str</code>, <code>str</code>], <strong><code>sheet_path</code></strong>:<code>Union</code>[<code>Path</code>, <code>str</code>], <strong><code>t_sleep</code></strong>:<code>float</code>=<em><code>0.01</code></em>, <strong><code>nmax</code></strong>:<code>int</code>=<em><code>None</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">file_title_maps</span> <span class="o">=</span> <span class="n">download_multiple_sheets</span><span class="p">(</span><span class="n">sheet_uris</span><span class="p">,</span> <span class="n">sheet_path</span><span class="o">=</span><span class="n">sheet_path</span><span class="p">,</span> <span class="n">nmax</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Loading-sheets-into-DataFrames">Loading sheets into DataFrames<a class="anchor-link" href="#Loading-sheets-into-DataFrames"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Collecting the <code>xlsx</code> and <code>xls</code> file names</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sheet_files</span> <span class="o">=</span> <span class="n">get_file_paths</span><span class="p">(</span><span class="n">sheet_path</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="n">RE_FNAME</span><span class="p">)</span>
<span class="n">sheet_files</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Reading files into dataframes</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="is_date" class="doc_header"><code>is_date</code><a href="https://github.com/eschmidt42/bundestag/tree/master/bundestag/parsing.py#L73" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>is_date</code>(<strong><code>s</code></strong>:<code>str</code>, <strong><code>fun</code></strong>:<code>Callable</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_sheet_df" class="doc_header"><code>get_sheet_df</code><a href="https://github.com/eschmidt42/bundestag/tree/master/bundestag/parsing.py#L82" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_sheet_df</code>(<strong><code>sheet_file</code></strong>:<code>Union</code>[<code>str</code>, <code>Path</code>], <strong><code>file_title_maps</code></strong>:<code>Dict</code>[<code>str</code>, <code>str</code>]=<em><code>None</code></em>)</p>
</blockquote>
<p>Parsing xlsx and xls files into dataframes</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="handle_title_and_date" class="doc_header"><code>handle_title_and_date</code><a href="https://github.com/eschmidt42/bundestag/tree/master/bundestag/parsing.py#L108" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>handle_title_and_date</code>(<strong><code>full_title</code></strong>:<code>str</code>, <strong><code>sheet_file</code></strong>)</p>
</blockquote>
<p>Extracting the title of the roll call vote and the date</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="disambiguate_party" class="doc_header"><code>disambiguate_party</code><a href="https://github.com/eschmidt42/bundestag/tree/master/bundestag/parsing.py#L125" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>disambiguate_party</code>(<strong><code>df</code></strong>:<code>DataFrame</code>, <strong><code>col</code></strong>:<code>str</code>=<em><code>'Fraktion/Gruppe'</code></em>, <strong><code>party_map</code></strong>:<code>dict</code>=<em><code>None</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">sheet_file</span> <span class="o">=</span> <span class="n">sheet_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">get_sheet_df</span><span class="p">(</span><span class="n">sheet_file</span><span class="p">,</span> <span class="n">file_title_maps</span><span class="o">=</span><span class="n">file_title_maps</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Squishing vote columns</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_squished_dataframe" class="doc_header"><code>get_squished_dataframe</code><a href="https://github.com/eschmidt42/bundestag/tree/master/bundestag/parsing.py#L131" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_squished_dataframe</code>(<strong><code>df</code></strong>:<code>DataFrame</code>, <strong><code>id_col</code></strong>:<code>str</code>=<em><code>'Bezeichnung'</code></em>, <strong><code>feature_cols</code></strong>:<code>List</code>[<code>str</code>]=<em><code>['ja', 'nein', 'Enthaltung', 'ungültig', 'nichtabgegeben']</code></em>, <strong><code>other_cols</code></strong>:<code>List</code>[<code>T</code>]=<em><code>None</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_squished</span> <span class="o">=</span> <span class="n">get_squished_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">df_squished</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Setting some dtypes</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="set_sheet_dtypes" class="doc_header"><code>set_sheet_dtypes</code><a href="https://github.com/eschmidt42/bundestag/tree/master/bundestag/parsing.py#L153" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>set_sheet_dtypes</code>(<strong><code>df</code></strong>:<code>DataFrame</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_squished</span> <span class="o">=</span> <span class="n">set_sheet_dtypes</span><span class="p">(</span><span class="n">df_squished</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Loading multiple sheets into dataframes</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_multiple_sheets_df" class="doc_header"><code>get_multiple_sheets_df</code><a href="https://github.com/eschmidt42/bundestag/tree/master/bundestag/parsing.py#L159" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_multiple_sheets_df</code>(<strong><code>sheet_files</code></strong>:<code>List</code>[<code>Union</code>[<code>Path</code>, <code>str</code>]], <strong><code>file_title_maps</code></strong>:<code>Dict</code>[<code>str</code>, <code>str</code>]=<em><code>None</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">get_multiple_sheets_df</span><span class="p">(</span><span class="n">sheet_files</span><span class="p">,</span> <span class="n">file_title_maps</span><span class="o">=</span><span class="n">file_title_maps</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Doing all the above</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_multiple_sheets" class="doc_header"><code>get_multiple_sheets</code><a href="https://github.com/eschmidt42/bundestag/tree/master/bundestag/parsing.py#L171" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_multiple_sheets</code>(<strong><code>html_path</code></strong>, <strong><code>sheet_path</code></strong>, <strong><code>nmax</code></strong>:<code>int</code>=<em><code>None</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">get_multiple_sheets</span><span class="p">(</span><span class="n">html_path</span><span class="p">,</span> <span class="n">sheet_path</span><span class="p">,</span> <span class="n">nmax</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Writing to disk</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="c1"># df.to_parquet(&#39;../roll_call_votes.parquet&#39;)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

