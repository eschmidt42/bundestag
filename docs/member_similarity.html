---

title: Member similarity


keywords: fastai
sidebar: home_sidebar

summary: "Computing the similarity of members of the Bundestag."
description: "Computing the similarity of members of the Bundestag."
nb_path: "nbs/02_member_similarity.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/02_member_similarity.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Setup">Setup<a class="anchor-link" href="#Setup"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Computing-similarities-between-members-of-parliament-based-on-their-votes">Computing similarities between members of parliament based on their votes<a class="anchor-link" href="#Computing-similarities-between-members-of-parliament-based-on-their-votes"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>complicating factors:</p>
<ul>
<li>not every parlamentarian voted for all the available issues</li>
<li>the union of issues voted on between parliamentarians may vary between all pairs of parliamentarian</li>
<li>similarity metric: cosine, agreement (# of same votes for all shared issues)</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="s1">&#39;../votes.parquet&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_squished_dataframe" class="doc_header"><code>get_squished_dataframe</code><a href="https://github.com/eschmidt42/bundestag/tree/master/bundestag/similarity.py#L14" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_squished_dataframe</code>(<strong><code>df</code></strong>:<code>DataFrame</code>, <strong><code>id_col</code></strong>:<code>str</code>=<em><code>'Bezeichnung'</code></em>, <strong><code>feature_cols</code></strong>:<code>List</code>[<code>str</code>]=<em><code>['ja', 'nein', 'Enthaltung', 'ung√ºltig', 'nichtabgegeben']</code></em>, <strong><code>topic_cols</code></strong>:<code>List</code>[<code>T</code>]=<em><code>['date', 'title']</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">df_squished</span> <span class="o">=</span> <span class="n">get_squished_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_squished</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_agreements_painfully_slow" class="doc_header"><code>get_agreements_painfully_slow</code><a href="https://github.com/eschmidt42/bundestag/tree/master/bundestag/similarity.py#L28" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_agreements_painfully_slow</code>(<strong><code>df</code></strong>:<code>DataFrame</code>, <strong><code>member0</code></strong>:<code>str</code>, <strong><code>member1</code></strong>:<code>str</code>, <strong><code>verbose</code></strong>:<code>bool</code>=<em><code>False</code></em>, <strong><code>id_col</code></strong>:<code>str</code>=<em><code>'Bezeichnung'</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">members</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Bezeichnung&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="n">num_members</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">members</span><span class="p">)</span>
<span class="n">members</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">member0</span> <span class="o">=</span> <span class="s1">&#39;Peter Altmaier&#39;</span>
<span class="c1">#member1 = &#39;Hubertus Heil (Peine)&#39;</span>
<span class="n">member1</span> <span class="o">=</span> <span class="s1">&#39;Dr. Angela Merkel&#39;</span>
<span class="k">assert</span> <span class="n">member0</span> <span class="ow">in</span> <span class="n">members</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">member0</span><span class="si">}</span><span class="s1"> not found&#39;</span>
<span class="k">assert</span> <span class="n">member1</span> <span class="ow">in</span> <span class="n">members</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">member1</span><span class="si">}</span><span class="s1"> not found&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">get_agreements_painfully_slow</span><span class="p">(</span><span class="n">df_squished</span><span class="p">,</span> <span class="n">member0</span><span class="p">,</span> <span class="n">member1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df_squished</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>General agreement
TODO: figure out how to do the relative ranking. one would need to count all the decisions which were the same as well as how many were different. the first part is a normal matrix product. the second part would be a matrix product with and "or" instead of the "and" condition of the normal matrix product. not sure how to do this yet</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_dummy" class="doc_header"><code>get_dummy</code><a href="https://github.com/eschmidt42/bundestag/tree/master/bundestag/similarity.py#L73" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_dummy</code>(<strong><code>df</code></strong>:<code>DataFrame</code>, <strong><code>mask</code></strong>:<code>Series</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="scan_all_agreements" class="doc_header"><code>scan_all_agreements</code><a href="https://github.com/eschmidt42/bundestag/tree/master/bundestag/similarity.py#L79" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>scan_all_agreements</code>(<strong><code>df</code></strong>:<code>DataFrame</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="n">agreements</span> <span class="o">=</span> <span class="n">scan_all_agreements</span><span class="p">(</span><span class="n">df_squished</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">v</span> <span class="ow">in</span> <span class="n">agreements</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">df_squished</span><span class="p">[</span><span class="s1">&#39;vote&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()])</span>
<span class="k">assert</span> <span class="s1">&#39;total_shared_votes&#39;</span> <span class="ow">in</span> <span class="n">agreements</span>
<span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">agreements</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">agreements</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Saving results</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;../similarities.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">agreements</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

